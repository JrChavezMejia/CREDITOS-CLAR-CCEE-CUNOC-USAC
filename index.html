<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>INSTRUMENTO CLAR – Planificación Semanal</title>
<style>
  /* Tipografías y tamaños solicitados */
  body { margin: 0; font-family: Arial, sans-serif; background: #ffffff; color: #0b1220; font-size: 10pt; }
  .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
  h1 { font-size: 11pt; font-weight: 800; margin: 0; }
  .page-header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px; }
  .logo-usac { height: 52px; width: auto; margin: 4px 0 2px 0; }
  .week h2 { font-size: 11pt; font-weight: 700; margin-bottom: 4px; }

  /* Bloques de semana */
  .week { margin-bottom: 20px; border: 1px solid #cbd5e1; border-radius: 8px; padding: 12px; background: #f9fafb; }
  .week-header { background-color: #d1fae5; padding: 12px; border-radius: 6px; margin-bottom: 12px; }
  .week-header div { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 6px; }
  .week-header label { font-weight: 600; margin-right: 4px; min-width: 160px; font-size: 10pt; }
  .week-header input, .week-header select, .week-header textarea { flex: 1; padding: 6px 8px; border: 1px solid #16a34a; border-radius: 4px; background: #d1fae5; font-size: 10pt; min-height: 24px; }
  .week-header textarea { resize: none; overflow-y: hidden; line-height: 1.2; white-space: pre-wrap; word-break: break-word; }
  .week-header .add-doc-inline { margin-left: 8px; padding: 4px 8px; border: 1px solid #16a34a; background:#eafff3; border-radius: 4px; font-size:10pt; cursor:pointer; }
  .week-header .add-doc-inline:hover { filter: brightness(0.95); }
  .docente-quick-input { margin-left: 8px; padding: 4px 8px; border: 1px solid #16a34a; background:#ffffff; border-radius: 4px; font-size:10pt; min-width: 180px; }

  /* Tabla de sesiones */
  table { width: 100%; border-collapse: collapse; table-layout: auto; }
  th, td { border: 1px solid #cbd5e1; padding: 6px; font-size: 10pt; vertical-align: top; text-align: center; }
  th { background: #f1f5f9; font-weight: 600; }
  th:nth-child(1), td:nth-child(1) { width: 1%; white-space: nowrap; }
  th:nth-child(2), td:nth-child(2) { width: 30%; white-space: normal; word-break: break-word; }
  th:nth-child(3), td:nth-child(3) { width: 40%; }
  th:nth-child(4), td:nth-child(4), th:nth-child(5), td:nth-child(5), th:nth-child(6), td:nth-child(6) { width: 120px; }

  /* Colores de modalidad (respetando su esquema) */
  .mod-teo td, .mod-teo { background: #f7c7cf; }
  .mod-pra td, .mod-pra { background: #cfe0f7; }
  .mod-aut td, .mod-aut { background: #fff5a8; }

  textarea, input[type="number"] { width: 100%; box-sizing: border-box; padding: 5px; font-size: 10pt; border: 1px solid #d1d5db; border-radius: 4px; background: #fff; min-height: 24px; }
  textarea { resize: none; overflow-y: hidden; line-height: 1.2; white-space: pre-wrap; word-break: break-word; }
  .description-cell textarea { width: 100%; }
  .short-input { width: 100%; max-width: none; }

  /* Barra de configuración */
  .add-week-btn { background: #10b981; color: white; padding: 10px 16px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; }
  .total-validation { font-weight: bold; margin-top: 10px; }

  .setup-bar { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:12px; }
  .setup-bar label { font-weight:600; }
  .setup-bar input[type="number"], .setup-bar input[type="date"] { padding:6px 10px; border:1px solid #94a3b8; border-radius:6px; font-size: 10pt; }

  /* Reporte final (respetar colores de imagen) */
  .report-wrap { margin-top: 18px; }
  .report-title { font-size: 11pt; font-weight: 700; margin: 10px 0 6px; }
  .report-table { width: 100%; border-collapse: collapse; table-layout: auto; }
  .report-table th, .report-table td { border: 1px solid #94a3b8; padding: 6px; font-size: 10pt; }
  /* Anchos y alineación del reporte final */
  .report-table th:nth-child(1), .report-table td:nth-child(1) { width: 55%; text-align: left; white-space: normal; word-break: break-word; }
  .report-table th:nth-child(2), .report-table td:nth-child(2) { width: 15%; text-align: right; }
  .report-table th:nth-child(3), .report-table td:nth-child(3) { width: 15%; text-align: right; }
  .report-table th:nth-child(4), .report-table td:nth-child(4) { width: 15%; text-align: right; }
  .report-head { background:#a7d7a7; font-weight:700; }
  .col-clar { background:#ff8c00; color:#000; font-weight:700; }
  .row-teo { background:#f7c7cf; }
  .row-pra { background:#cfe0f7; }
  .row-aut { background:#fff5a8; }
  .row-total td { font-weight:700; }

  /* Export & print */
  .export-actions { display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; }
  .export-actions .btn { background:#0ea5e9; color:#fff; border:none; border-radius:6px; padding:10px 14px; font-weight:700; cursor:pointer; }
  .export-actions .btn.word { background:#6366f1; }
  .export-actions .btn.pdf { background:#ef4444; }
  .export-actions .btn:hover { filter:brightness(0.95); }

  @media print {
    /* Fuente obligatoria en PDF */
    * { font-family: Arial, sans-serif !important; font-size: 10pt !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

    /* Mantener colores de fondo exactamente como en pantalla */
    body, .week, .week-header, table, th, td { background: inherit; }
    .week-header { background-color: #d1fae5 !important; }
    th { background: #f1f5f9 !important; }
    .mod-teo td, .mod-teo { background: #f7c7cf !important; }
    .mod-pra td, .mod-pra { background: #cfe0f7 !important; }
    .mod-aut td, .mod-aut { background: #fff5a8 !important; }
    .report-head { background: #a7d7a7 !important; }
    .col-clar { background: #ff8c00 !important; }

    /* Componentes que no van al PDF */
    .setup-bar, .export-actions { display: none !important; }

    /* Evitar cortes feos */
    .week { break-inside: avoid; page-break-inside: avoid; }
  }

  @page { size: A4; margin: 12mm; }
</style>
</head>
<body>
<div class="container">
  <div class="page-header">
    <h1>INSTRUMENTO CLAR · Planificación Semanal</h1>
    <img class="logo-usac" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAR4AAACQCAYAAADeBATKAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFxEAABcRAcom8z8AAMf8SURBVHhe7F0HVFXH1j730uwlRmN6r0bFlsSY3ns3PTH23hWRooCiqEgTRESwF8AC0nuvIlURBCuCClbsin7/+g6M77yTi14F85L87rX2unDO9NnzzZ49e+ZI164B/yrG7dO1a9ealNWkfv+fcKpnV6/i6tWrDaZzlxomddv+G5mCrn72T2NJ3XH/n0ndOI3l2yEBOnfp9kjdB3f578mS+sH/R+ZAV2oYTcV36a8ndR/c5b8n3wWeO8h36a8ndR/8f+O/0zLsRmW5u9S6S3fpLt1RUoPOXeC5S3fpLt1xUoPOXeC5S3fpLt1xUoPOXeC5S3fpLt1xUoPOXeC5S3fpLt1xUoPOXeC5S3fpLt1xUoPOXeC5S3fpLt1xUoPOvwJ4REUECUdA9d936X9D6r4Q/6v/1vVM2Xd3+7GuDXU5upJ0tZs6zP+K1OUl/yuAR/ySlR2j/vvuUYT/DSnbX9kH6v4QfcnntbW1fwKr/8+kbkPRPg2RWu7/l20oyqLkfzzw3KW/P6mF/uLFizh//rzM586dk/nChQvy7+XLl+VBpYynjv//kdRtcOXKFbn92G7ks2fPoqam5r+eiXb8X5MadP4RjKaNDnW8wtrDRdEa10SM3Iivesn30u5Au5r8nSdm++x458V3/5///WmY+n74o73+v94vb8EXPfb58Dz0+X8b/LV3czy9q5z/6285mcxvvlpzD4f6CNxB+Xsl8dXx1/P99fNHXDOT46t3i/3PHPyudrxTP547PE+dLJ0EkTU0wceELHlO4fF/4lC9MTsgSVPIJRvwfA0JeQ/vV8eUPeZXvxd8tv/iDgPJ5X/XxOuGDy6V443b/4xPXvtcA+3jx33j7VfpS6SvFc9HxeeJ86fQvFM/FSa7J50UmvIPAMxjcTEx6B8kXfm/oq+P/5RDaXvylUZ8ikmvynXCfgvEpJ1FGvk/8fpX+Z9P/Bo+OUqlc5iXWAAAAAElFTkSuQmCC" alt="USAC CUNOC" />
  </div>

  <div class="setup-bar" role="region" aria-label="Configuración de semanas">
    <label>Semanas:
      <input type="number" id="weeks-count" min="1" max="40" value="16" />
    </label>
    <label>Inicio (YYYY-MM-DD):
      <input type="date" id="weeks-start" />
    </label>
    <label style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="weeks-snap" checked /> Ajustar al lunes (Lun–Vie)
    </label>
    <button id="create-weeks" class="add-week-btn">Crear semanas</button>
  </div>

  <div id="weeks-container"></div>
  <div id="validation-result" class="total-validation"></div>

  <!-- Reporte final -->
  <div id="summary-report" class="report-wrap"></div>

  <div class="export-actions">
    <button id="btn-export-excel" class="btn excel">Exportar a Excel</button>
    <button id="btn-export-word" class="btn word">Exportar a Word</button>
    <button id="btn-export-pdf" class="btn pdf">Exportar a PDF</button>
  </div>
</div>

<script>
  // ======= Estado global =======
  let weekCount = 0;
  const CLAR_HOURS_DIVISOR = 24; // CLAR = (Σ horas) / 24

  // ======= Utilidades =======
  function autoResize(el){ if(!el) return; el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
  function initAutosize(scope){ (scope || document).querySelectorAll('textarea').forEach(t=>{ autoResize(t); t.addEventListener('input', ()=>autoResize(t)); }); }

  function parseLocalDate(str){
    if (typeof str !== 'string') return new Date(str);
    const parts = str.split('-');
    if (parts.length !== 3) return new Date(str);
    const y = parseInt(parts[0],10), mo = parseInt(parts[1],10)-1, d = parseInt(parts[2],10);
    return new Date(y, mo, d); // medianoche local
  }
  function addDays(date, days){ const d = new Date(date.getTime()); d.setDate(d.getDate()+days); return d; }
  function toMonday(date){ const d = new Date(date.getTime()); const day = d.getDay(); const diff = (day === 0 ? -6 : 1 - day); d.setDate(d.getDate()+diff); return d; }
  function formatDMY(date){ const dd = String(date.getDate()).padStart(2,'0'); const mm = String(date.getMonth()+1).padStart(2,'0'); const yyyy = date.getFullYear(); return `${dd}/${mm}/${yyyy}`; }
  function endOfWorkWeek(monday){ return addDays(monday, 4); }
  function parseNum(val){ if (val==null) return NaN; return parseFloat(String(val).replace(',', '.')); }

  // ======= Encabezado (solo Semana 1 editable; se replica al resto) =======
  const HEADER_FIELDS = [
    {sel: '[data-field="centro"]'},
    {sel: '[data-field="division"]'},
    {sel: 'select[data-field="carrera"]'},
    {sel: '[data-field="cod_carrera"]'},
    {sel: '[data-field="curso"]'},
    {sel: '[data-field="cod_curso"]'},
    {sel: '[data-field="requisito"]'},
    {sel: '[data-field="postrequisito"]'},
    {sel: '[data-field="docente"]'}
  ];

  function buildWeekHeader(isSlave = false) {
    const ro = isSlave ? 'readonly' : '';
    const dis = isSlave ? 'disabled' : '';
    const addBtn = isSlave ? '' : '<button type="button" class="add-doc-inline" title="Agregar otro docente">+ Docente</button>';
    return `
      <div class="week-header" data-role="${isSlave ? 'slave' : 'master'}">
        <div><label>Centro Universitario:</label>
          <textarea data-field="centro" ${ro}>Centro Universitario de Occidente (CUNOC)</textarea></div>
        <div><label>División:</label>
          <textarea data-field="division" ${ro}>Ciencias Económicas (CCEE)</textarea></div>
        <div><label>Carrera:</label>
          <select data-field="carrera" ${dis}>
            <option>Administración de Empresas</option>
            <option>Contaduría Pública y Auditoría</option>
            <option>Economía</option>
            <option>Área Común</option>
          </select>
        </div>
        <div><label>Código de la carrera:</label>
          <textarea data-field="cod_carrera" ${ro}>120004</textarea></div>
        <div><label>Nombre del curso:</label>
          <textarea data-field="curso" ${ro}>Mercadotecnia II</textarea></div>
        <div><label>Código del curso:</label>
          <textarea data-field="cod_curso" ${ro}>482</textarea></div>
        <div><label>Requisito:</label>
          <textarea data-field="requisito" ${ro}>Mercadotecnia I</textarea></div>
        <div><label>Postrequisito:</label>
          <textarea data-field="postrequisito" ${ro}>—</textarea></div>
        <div style="align-items:center"><label>Docente:</label>
          <textarea data-field="docente" ${ro}></textarea>
          ${addBtn}
        </div>
      </div>
    `;
  }

  function getMasterHeader() { return document.querySelector('#weeks-container .week:first-child .week-header'); }
  function getSlaveHeaders() { return document.querySelectorAll('#weeks-container .week:not(:first-child) .week-header'); }

  function readHeaderValues(headerEl) {
    const vals = {};
    HEADER_FIELDS.forEach(({sel}) => {
      const el = headerEl.querySelector(sel);
      if (!el) return;
      vals[el.dataset.field] = el.value;
    });
    return vals;
  }

  function writeHeaderValues(headerEl, values) {
    HEADER_FIELDS.forEach(({sel}) => {
      const el = headerEl.querySelector(sel);
      if (!el) return;
      el.value = values[el.dataset.field] ?? el.value;
      if (el.tagName === 'TEXTAREA') { autoResize(el); }
    });
  }

  function syncAllSlaves() {
    const master = getMasterHeader();
    if (!master) return;
    const values = readHeaderValues(master);
    getSlaveHeaders().forEach(h => writeHeaderValues(h, values));
  }

  function enableLiveSync() {
    const master = getMasterHeader();
    if (!master) return;
    const inputs = master.querySelectorAll('[data-field], select[data-field]');
    inputs.forEach(inp => {
      inp.addEventListener('input', () => { syncAllSlaves(); if (inp.tagName === 'TEXTAREA') autoResize(inp); });
      inp.addEventListener('change', () => { syncAllSlaves(); if (inp.tagName === 'TEXTAREA') autoResize(inp); });
      if (inp.tagName === 'TEXTAREA') autoResize(inp);
    });
  }

  // ======= Filas de sesiones =======
  function createSessionRow(session, modality, modClass) {
    return `
      <tr class="${modClass}">
        <td>${session}</td>
        <td>${modality}</td>
        <td class="description-cell"><textarea oninput="autoResize(this)"></textarea></td>
        <td><input type="number" step="any" class="short-input minutos" /></td>
        <td><input type="number" step="any" class="short-input puntos-netos" /></td>
        <td><input type="number" class="short-input puntos-acumulados" readonly /></td>
      </tr>
    `;
  }

  // ======= Crear semana =======
  function addWeek(startDateOverride) {
    weekCount++;
    const container = document.getElementById('weeks-container');
    const weekDiv = document.createElement('div');
    weekDiv.className = 'week';
    const isSlave = weekCount > 1;

    // Rango de la semana (Lun–Vie) + Inicio mostrado
    let labelFecha = '';
    let rangeHTML = '';
    if (startDateOverride instanceof Date) {
      const d = new Date(startDateOverride.getTime());
      const monday = toMonday(d);
      const friday = endOfWorkWeek(monday);
      labelFecha = ` — Inicio: ${formatDMY(d)}`;
      rangeHTML = `<div class="week-range">Semana del ${formatDMY(monday)} al ${formatDMY(friday)} (Lun–Vie)</div>`;
    }

    weekDiv.innerHTML = `
      ${buildWeekHeader(isSlave)}
      <h2>Semana ${weekCount}${labelFecha}</h2>
      ${rangeHTML}
      <table>
        <thead>
          <tr>
            <th>Sesión</th>
            <th>Modalidad</th>
            <th>Descripción</th>
            <th>Minutos</th>
            <th>Puntos netos</th>
            <th>Puntos acumulados</th>
          </tr>
        </thead>
        <tbody>
          ${['1','2','3'].map(s => `
            ${createSessionRow('Sesión ' + s, 'Presencial teórico/ virtual/sincrónico', 'mod-teo')}
            ${createSessionRow('Sesión ' + s, 'Presencial práctico/virtual/sincrónico. Interacción de profesor y estudiante', 'mod-pra')}
            ${createSessionRow('Sesión ' + s, 'No presencial (autónomo)', 'mod-aut')}
          `).join('')}
        </tbody>
      </table>
    `;
    container.appendChild(weekDiv);

    initAutosize(weekDiv);

    // Enlazar eventos de puntos y minutos para recalcular en vivo y guardar
    weekDiv.querySelectorAll('.puntos-netos, .minutos').forEach(inp => {
      inp.addEventListener('input', () => { computeAllClar(); scheduleSave(); });
      inp.addEventListener('change', () => { computeAllClar(); scheduleSave(); });
    });

    if (isSlave) {
      const master = getMasterHeader();
      if (master) {
        const vals = readHeaderValues(master);
        writeHeaderValues(weekDiv.querySelector('.week-header'), vals);
      }
    } else {
      setTimeout(() => { enableLiveSync(); initAutosize(document); }, 0);
    }

    computeAllClar();
  }

  // ======= Cálculos CLAR / puntos =======
  function computeAllClar(){
    // Total de minutos: sumar todos los inputs .minutos del contenedor
    let totalMinutes = 0;
    document.querySelectorAll('#weeks-container .minutos').forEach(i => {
      const v = parseNum(i.value);
      if (Number.isFinite(v)) totalMinutes += v;
    });

    // Puntos netos acumulados por semana
    document.querySelectorAll('#weeks-container .week').forEach(week => {
      let runningPts = 0; const rows = week.querySelectorAll('.puntos-netos');
      const acc = week.querySelectorAll('.puntos-acumulados');
      rows.forEach((inp, idx) => { runningPts += parseNum(inp.value)||0; if (acc[idx]) acc[idx].value = runningPts.toFixed(2); });
    });

    // CLAR total = (Σ horas) / 24
    const totalHours = totalMinutes / 60;
    const clarTotal = totalHours / CLAR_HOURS_DIVISOR;
    const result = document.getElementById('validation-result');
    if (result) {
      result.textContent = `CLAR total (Σ horas / 24): ${clarTotal.toFixed(9)}`;
      result.style.color = '#0b1220';
    }

    computeSummaryReport();
  }

  // ======= Reporte final =======
  function computeSummaryReport(){
    const sumBy = { teo:0, pra:0, aut:0 };
    document.querySelectorAll('#weeks-container .minutos').forEach(inp => {
      const val = parseNum(inp.value);
      const v = Number.isFinite(val) ? val : 0;
      const tr = inp.closest('tr');
      if (!tr) return;
      if (tr.classList.contains('mod-teo')) sumBy.teo += v;
      else if (tr.classList.contains('mod-pra')) sumBy.pra += v;
      else if (tr.classList.contains('mod-aut')) sumBy.aut += v;
    });

    const hours = {
      teo: sumBy.teo/60,
      pra: sumBy.pra/60,
      aut: sumBy.aut/60,
    };
    const totals = {
      min: sumBy.teo + sumBy.pra + sumBy.aut,
      hrs: (sumBy.teo + sumBy.pra + sumBy.aut)/60,
      clar: ((sumBy.teo + sumBy.pra + sumBy.aut)/60) / CLAR_HOURS_DIVISOR,
    };
    const fmt = (n, d=2)=> Number.isFinite(n) ? n.toFixed(d) : '0.00';

    const html = `
      <div class="report-title">REPORTE FINAL</div>
      <table class="report-table">
        <colgroup>
          <col />
          <col />
          <col />
          <col class="col-clar" />
        </colgroup>
        <thead>
          <tr class="report-head">
            <th>TIPO DE TRABAJO</th>
            <th>Minutos por Semestre</th>
            <th>Horas por Semestre (min/60)</th>
            <th>CLAR</th>
          </tr>
        </thead>
        <tbody>
          <tr class="row-teo"><td>Presencial teórico/ virtual/sincrónico</td><td>${fmt(sumBy.teo,0)}</td><td>${fmt(hours.teo,2)}</td><td></td></tr>
          <tr class="row-pra"><td>Presencial práctico/ virtual/sincrónico. Interacción de profesor y estudiante</td><td>${fmt(sumBy.pra,0)}</td><td>${fmt(hours.pra,2)}</td><td></td></tr>
          <tr class="row-aut"><td><strong>Autónomo</strong></td><td>${fmt(sumBy.aut,0)}</td><td>${fmt(hours.aut,2)}</td><td></td></tr>
          <tr class="row-total"><td><strong>Total</strong></td><td><strong>${fmt(totals.min,0)}</strong></td><td><strong>${fmt(totals.hrs,2)}</strong></td><td class="col-clar"><strong>${fmt(totals.clar,9)}</strong></td></tr>
        </tbody>
      </table>`;
    const mount = document.getElementById('summary-report');
    if (mount) mount.innerHTML = html;
  }

  // ======= Controladores =======
  function onPointsChange(){ computeAllClar(); }
  function onMinutesChange(){ computeAllClar(); }

  function generateWeeksFromControls(){
    try {
      const countEl = document.getElementById('weeks-count');
      const startEl = document.getElementById('weeks-start');
      const snapEl = document.getElementById('weeks-snap');
      const n = parseInt(countEl.value, 10);
      if (!Number.isInteger(n) || n <= 0) { alert('Ingrese un número válido de semanas.'); return; }

      const baseRaw = startEl.value ? parseLocalDate(startEl.value) : new Date();
      if (isNaN(baseRaw.getTime())) { alert('Fecha inválida. Use el selector de fecha.'); return; }

      const base = snapEl && snapEl.checked ? toMonday(baseRaw) : baseRaw;

      const container = document.getElementById('weeks-container');
      container.innerHTML = '';
      weekCount = 0;

      for (let i = 0; i < n; i++) addWeek(addDays(base, 7*i));
    } catch(e) {
      console.error(e); alert('No se pudieron crear las semanas desde la barra.');
    }
  }

  // ======= Persistencia (autosave en localStorage) =======
  const STORAGE_KEY = 'clar_usac_autosave_v1';

  function collectState(){
    const state = {
      controls: {
        weeks: parseInt(document.getElementById('weeks-count').value||'0',10),
        start: document.getElementById('weeks-start').value||'',
        snap: !!document.getElementById('weeks-snap').checked
      },
      header: readHeaderValues(getMasterHeader() || document.createElement('div')),
      weeks: []
    };
    document.querySelectorAll('#weeks-container .week').forEach(week => {
      const rows = Array.from(week.querySelectorAll('tbody tr')).map(tr=>({
        desc: tr.querySelector('textarea')?.value||'',
        min: tr.querySelector('input.minutos')?.value||'',
        pts: tr.querySelector('input.puntos-netos')?.value||''
      }));
      state.weeks.push({ rows });
    });
    return state;
  }
  function applyState(state){
    if(!state) return;
    // Re-crear estructura de semanas desde controles guardados
    try{
      document.getElementById('weeks-count').value = state.controls.weeks || 16;
      document.getElementById('weeks-start').value = state.controls.start || '';
      document.getElementById('weeks-snap').checked = !!state.controls.snap;
      generateWeeksFromControls();
    }catch(e){ console.warn('No se pudo regenerar estructura:', e); }
    // Escribir encabezado maestro y replicar
    const master = getMasterHeader();
    if (master && state.header) { writeHeaderValues(master, state.header); syncAllSlaves(); }
    // Volcar filas
    const weeks = document.querySelectorAll('#weeks-container .week');
    weeks.forEach((weekEl, wi)=>{
      const w = state.weeks[wi]; if(!w) return;
      const trs = weekEl.querySelectorAll('tbody tr');
      w.rows?.forEach((row, ri)=>{
        const tr = trs[ri]; if(!tr) return;
        const ta = tr.querySelector('textarea'); if(ta){ ta.value = row.desc||''; autoResize(ta); }
        const min = tr.querySelector('input.minutos'); if(min){ min.value = row.min||''; }
        const pts = tr.querySelector('input.puntos-netos'); if(pts){ pts.value = row.pts||''; }
      });
    });
    computeAllClar();
  }

  let saveTimer=null;
  function scheduleSave(){ clearTimeout(saveTimer); saveTimer = setTimeout(()=>{
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(collectState())); }catch(e){ console.warn('Autosave falló:', e); }
  }, 400); }

  function tryRestore(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      const data = JSON.parse(raw);
      applyState(data);
      return true;
    }catch(e){ console.warn('Restauración falló:', e); return false; }
  }

  // ======= Exportación =======
  function buildExportHTML(){
    const head = document.querySelector('.page-header')?.outerHTML || '';
    const meta = '<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge">';
    const styles = `<style>table{border-collapse:collapse;width:100%}th,td{border:1px solid #999;padding:4px} .mod-teo td,.mod-teo{background:#f7c7cf} .mod-pra td,.mod-pra{background:#cfe0f7} .mod-aut td,.mod-aut{background:#fff5a8} .report-head{background:#a7d7a7;font-weight:bold} .col-clar{background:#ff8c00}</style>`;
    const weeks = document.getElementById('weeks-container')?.innerHTML || '';
    const report = document.getElementById('summary-report')?.innerHTML || '';
    return `<!DOCTYPE html><html><head>${meta}${styles}<title>INSTRUMENTO CLAR</title></head><body>${head}${weeks}${report}</body></html>`;
  }

  function downloadBlob(filename, mime, content){
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  function exportExcel(){
    const html = buildExportHTML();
    downloadBlob('instrumento_clar.xls', 'application/vnd.ms-excel', html);
  }
  function exportWord(){
    const html = buildExportHTML();
    downloadBlob('instrumento_clar.doc', 'application/msword', html);
  }
  function exportPDF(){
    window.print(); // El usuario puede guardar como PDF desde el diálogo de impresión
  }

  // ======= Wire-up de eventos =======
  document.getElementById('create-weeks').addEventListener('click', generateWeeksFromControls);

  // Eventos de exportación
  (function(){
    const ex = document.getElementById('btn-export-excel');
    const wd = document.getElementById('btn-export-word');
    const pf = document.getElementById('btn-export-pdf');
    if (ex) ex.addEventListener('click', exportExcel);
    if (wd) wd.addEventListener('click', exportWord);
    if (pf) pf.addEventListener('click', exportPDF);
  })();

  // Autosave global y recálculo en caliente
  (function(){
    const root = document;
    root.addEventListener('input', (e)=>{
      if (e.target.matches('input, textarea, select')) scheduleSave();
      if (e.target.matches('.minutos, .puntos-netos')) computeAllClar();
    });
    root.addEventListener('change', (e)=>{
      if (e.target.matches('input, textarea, select')) scheduleSave();
    });
    window.addEventListener('beforeunload', ()=>{ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(collectState())); }catch(_){} });
  })();

  // Restaurar al cargar o preparar reporte en blanco
  (function(){
    const restored = tryRestore();
    if (!restored) computeSummaryReport();
  })();

  // Delegación: manejar clicks en "+ Docente"
  function openDocenteQuickInput(){
    const header = getMasterHeader();
    if (!header) return;
    if (header.querySelector('.docente-quick-input')) return; // evitar duplicado
    const docEl = header.querySelector('[data-field="docente"]');
    const btn = header.querySelector('.add-doc-inline');
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Nuevo docente… (Enter para agregar)';
    input.className = 'docente-quick-input';
    btn.insertAdjacentElement('afterend', input);
    input.focus();
    const commit = ()=>{
      const extra = (input.value||'').trim();
      if (extra) {
        const base = (docEl?.value || '').trim();
        if (docEl) docEl.value = base ? base + ', ' + extra : extra;
        if (docEl) { autoResize(docEl); }
        syncAllSlaves();
        scheduleSave();
      }
      input.remove();
    };
    input.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') { e.preventDefault(); commit(); }
      else if (e.key === 'Escape') { e.preventDefault(); input.remove(); }
    });
    input.addEventListener('blur', ()=>{ commit(); });
  }
  function handleAddDocClick(evt){
    const btn = evt.target.closest('.add-doc-inline');
    if (!btn) return;
    evt.preventDefault();
    openDocenteQuickInput();
  }
  document.addEventListener('click', handleAddDocClick);

  // ======= Pruebas rápidas (no intrusivas) =======
  (function runSelfTests(){
    try {
      // Zona horaria (parser local)
      console.assert(formatDMY(parseLocalDate('2025-10-14')) === '14/10/2025', 'parseLocalDate mantiene 14/10/2025');
      console.assert(formatDMY(toMonday(parseLocalDate('2025-10-14'))) === '13/10/2025', 'toMonday ajusta a lunes 13/10/2025');
      // Utilidades
      console.assert(formatDMY(toMonday(new Date('2025-01-22'))) === '20/01/2025', 'toMonday 22→20/01/2025');
      console.assert(formatDMY(endOfWorkWeek(new Date('2025-01-20'))) === '24/01/2025', 'viernes 24/01/2025');
      console.assert(formatDMY(addDays(new Date('2025-01-01'), 7)) === '08/01/2025', '+7 días correcto');
      // Existencia de controladores claves
      console.assert(typeof generateWeeksFromControls === 'function', 'generateWeeksFromControls definida');
      // Verificación: CLAR = (Σ horas) / 24
      (function(){ const mins=240; const hours=mins/60; const clar=hours/CLAR_HOURS_DIVISOR; console.assert(Math.abs(clar - ((mins/60)/24))<1e-9, 'CLAR = horas/24 correcto'); })();
    } catch(e) { console.warn('SelfTests failed:', e); }
  })();
</script>
</body>
</html>
