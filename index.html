<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>INSTRUMENTO CLAR – Planificación Semanal</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#ffffff; --fg:#0b1220; --muted:#475569; --brand:#16a34a; --brand-2:#0ea5e9;
    --surface:#f9fafb; --surface-2:#eafff3; --surface-3:#d1fae5; --border:#cbd5e1; --border-2:#94a3b8;
    --warn:#ef4444; --focus:#7c3aed; --shadow:0 2px 10px rgba(0,0,0,.06);
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1220; --fg:#e5e7eb; --muted:#94a3b8; --surface:#0f172a; --surface-2:#0b2a18; --surface-3:#0f3d24; --border:#334155; --border-2:#475569; }
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", sans-serif; background:var(--bg); color:var(--fg); font-size:10pt }
  .container{ max-width:1200px; margin:0 auto; padding:20px }
  h1{ font-size:12pt; font-weight:800; margin:0 }
  .page-header{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px }
  .logo-usac{ height:52px; width:auto; margin:4px 0 2px 0 }

  /* Barra de configuración */
  .setup-bar{ position:sticky; top:0; z-index:5; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:10px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; box-shadow:var(--shadow); margin-bottom:12px }
  .setup-bar label{ font-weight:600 }
  .setup-bar input[type="number"], .setup-bar input[type="date"]{ padding:6px 10px; border:1px solid var(--border-2); border-radius:8px; font-size:10pt; background:var(--bg); color:var(--fg) }
  .btn{ background:var(--brand-2); color:#fff; border:none; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer }
  .btn:hover{ filter:brightness(.95) }
  .btn.success{ background:#10b981 }
  .btn.warn{ background:var(--warn) }
  .btn.ghost{ background:transparent; border:1px solid var(--border-2); color:var(--fg) }
  .btn-sm{ font-size:9pt; padding:6px 10px; border-radius:8px; cursor:pointer; border:1px solid var(--border-2); background:var(--surface); color:var(--fg) }

  /* Gestión de cursos */
  .course-manager{ background:var(--surface-2); border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:12px }
  .course-manager h3{ margin:0 0 8px 0; font-size:11pt }
  .course-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  .course-select{ flex:1; min-width:200px; padding:6px 8px; border:1px solid var(--border-2); border-radius:8px; background:var(--bg) }

  /* Encabezado maestro */
  .master-header{ background:var(--surface-3); padding:14px; border-radius:12px; margin:12px 0; border:1px solid var(--brand); display:block }
  .header-top{ display:grid; grid-template-columns: 1fr 280px; gap:16px; align-items:start }
  .top-left{ display:grid; grid-template-columns: 1fr; gap:12px }
  .header-logos{ background:var(--surface-2); border:1px dashed var(--brand); border-radius:12px; padding:10px; text-align:center }
  .header-logos h3{ font-size:11pt; margin:0 0 10px 0; text-align:center; font-weight:bold }
  .logos-container{ display:flex; flex-direction:column; gap:10px; align-items:center }
  .logo-combined{ display:flex; gap:15px; justify-content:center; align-items:center; flex-wrap:wrap }
  .logo-item{ display:flex; flex-direction:column; align-items:center; gap:5px }
  .logo-preview{ width:80px; height:80px; object-fit:contain; background:#fff; border:1px solid var(--border-2); border-radius:8px; padding:4px }
  .logo-label{ font-size:9pt; font-weight:600; text-align:center }
  .logo-actions{ display:flex; gap:6px; flex-wrap:wrap; justify-content:center }
  .logo-actions .btn-sm{ padding:4px 8px; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:8pt }
  .btn-outline{ background:#ffffff; border:1px solid var(--brand) }
  .header-bottom{ margin-top:16px; display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center }
  .row.span-2{ grid-column:1 / -1 }
  @media (max-width: 860px){ .header-top{ grid-template-columns:1fr } .header-bottom{ grid-template-columns:1fr } }
  .master-header label{ font-weight:700; min-width:140px; margin-right:4px; color:var(--fg) }
  .master-header input, .master-header select, .master-header textarea{ flex:1; padding:6px 8px; border:1px solid var(--brand); border-radius:8px; background:var(--surface-2); font-size:10pt; resize:none; overflow-y:hidden; line-height:1.2; white-space:pre-wrap; word-break:break-word; color:var(--fg); font-weight:normal }
  .master-header textarea[readonly]{ background:var(--surface-2); color:var(--fg); cursor:not-allowed }
  .master-header .field-value{ font-weight:normal !important }

  /* Campos de solo lectura para PDF */
  .print-field{ 
    padding:6px 8px; 
    border:1px solid var(--brand); 
    border-radius:8px; 
    background:var(--surface-2); 
    font-size:10pt; 
    line-height:1.2; 
    white-space:pre-wrap; 
    word-break:break-word; 
    color:var(--fg); 
    font-weight:normal;
    min-height: 24px;
  }

  /* Semana y tabla */
  .week{ margin-bottom:20px; border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--surface); position:relative }
  .exam-badge{ position:absolute; right:12px; top:-10px; background:#fde68a; border:1px solid #f59e0b; padding:2px 8px; border-radius:999px; font-weight:800; font-size:9pt }
  .week h2{ font-size:11pt; font-weight:700; margin:0 0 8px }
  .week-range{ color:var(--muted); font-style:italic; margin-bottom:6px }
  table{ width:100%; border-collapse:collapse; table-layout:auto }
  th, td{ border:1px solid var(--border); padding:6px; font-size:10pt; vertical-align:top; text-align:center }
  th{ background:#f1f5f9; font-weight:600 }
  th:nth-child(1), td:nth-child(1){ width:1%; white-space:nowrap }
  th:nth-child(2), td:nth-child(2){ width:30%; white-space:normal; word-break:break-word }
  th:nth-child(3), td:nth-child(3){ width:40% }
  th:nth-child(4), td:nth-child(4), th:nth-child(5), td:nth-child(5), th:nth-child(6), td:nth-child(6){ width:120px }

  /* Colores de modalidad */
  .mod-teo td, .mod-teo{ background:#f7c7cf }
  .mod-pra td, .mod-pra{ background:#cfe0f7 }
  .mod-aut td, .mod-aut{ background:#fff5a8 }

  textarea, input[type="number"], input[type="text"], select{ width:100%; box-sizing:border-box; padding:5px; font-size:10pt; border:1px solid #d1d5db; border-radius:8px; background:#fff; min-height:24px; font-weight:normal }
  textarea{ resize:none; overflow-y:hidden; line-height:1.2; white-space:pre-wrap; word-break:break-word }

  /* Resumen semanal */
  .week-summary{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:8px 0 0; font-size:10pt }
  .badge{ display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--border-2); background:var(--surface-2) }
  .badge.warn{ border-color:var(--warn); background:#fee2e2 }
  .note-muted{ color:var(--muted); font-style:italic }

  /* Evaluación */
  .eval-wrap{ margin-top:18px }
  .eval-title{ font-size:11pt; font-weight:800; margin:10px 0 6px }
  .eval-table{ width:100%; border-collapse:collapse; table-layout:auto }
  .eval-table th, .eval-table td{ border:1px solid var(--border-2); padding:6px; font-size:10pt }
  .eval-table th:nth-child(1), .eval-table td:nth-child(1){ text-align:left }
  .eval-table th:nth-child(2), .eval-table td:nth-child(2){ text-align:right; width:120px }
  .eval-head{ background:#dbeafe; font-weight:700 }
  .eval-total td{ font-weight:800 }
  .over-cap{ background:#fee2e2 !important; color:#7f1d1d !important; font-weight:800; }

  /* Reporte final */
  .report-wrap{ margin-top:18px }
  .report-title{ font-size:11pt; font-weight:700; margin:10px 0 6px }
  .report-table{ width:100%; border-collapse:collapse; table-layout:auto }
  .report-table th, .report-table td{ border:1px solid var(--border-2); padding:6px; font-size:10pt }
  .report-table th:nth-child(1), .report-table td:nth-child(1){ width:55%; text-align:left; white-space:normal; word-break:break-word }
  .report-table th:nth-child(2), .report-table td:nth-child(2),
  .report-table th:nth-child(3), .report-table td:nth-child(3),
  .report-table th:nth-child(4), .report-table td:nth-child(4){ width:15%; text-align:right }
  .report-head{ background:#a7d7a7; font-weight:700 }
  .clar-merged{ background:#ff8c00; color:#000; font-weight:800; font-size:18pt; text-align:center; vertical-align:middle }
  .row-teo{ background:#f7c7cf }
  .row-pra{ background:#cfe0f7 }
  .row-aut{ background:#fff5a8 }
  .row-total td{ font-weight:700 }

  /* Secciones finales */
  .final-wrap{ margin-top:18px }
  .final-title{ text-align:center; font-weight:800; font-size:11pt; border:1px solid var(--brand); border-bottom:none; padding:6px 8px; border-radius:10px 10px 0 0; background:var(--surface-3) }
  .final-body{ border:1px solid var(--brand); padding:8px; border-radius:0 0 10px 10px; background:var(--surface-3) }
  .final-body textarea{ width:100%; border:none; outline:none; background:var(--surface-2); min-height:90px; font-size:10pt; line-height:1.4; color:var(--fg); font-weight:normal }
  .final-note{ font-size:9pt; color:var(--muted) }

  /* Exportación */
  .export-actions{ display:flex; gap:12px; flex-wrap:wrap; margin-top:14px }

  /* Accesibilidad visual */
  :focus{ outline:3px solid var(--focus); outline-offset:2px }

  /* Logos flotantes para PDF */
  .pdf-logos {
    display: none;
  }

  /* Impresión - MANTENER TODOS LOS ESTILOS EN PDF */
  @media print{
    *{ 
      font-family: Arial, sans-serif !important; 
      font-size:10pt !important; 
      -webkit-print-color-adjust:exact !important; 
      print-color-adjust:exact !important;
      color-adjust: exact !important;
    }
    body{ background:white !important; color:black !important }
    .container{ max-width:100% !important; padding:10px !important }
    
    /* Logos en esquina superior derecha para PDF */
    .pdf-logos {
      display: block !important;
      position: fixed;
      top: 10mm;
      right: 10mm;
      z-index: 1000;
      text-align: right;
    }
    
    .pdf-logo-combined {
      display: flex;
      flex-direction: column;
      gap: 5mm;
      align-items: flex-end;
    }
    
    .pdf-logo {
      width: 25mm !important;
      height: auto !important;
      max-height: 20mm;
      object-fit: contain;
    }
    
    /* Mantener colores del encabezado */
    .master-header{ 
      background:#d1fae5 !important; 
      border:1px solid #16a34a !important;
      border-radius:12px !important;
      padding:14px !important;
      margin:12px 0 !important;
    }
    .master-header label{ font-weight:bold !important; color:#000 !important }
    .master-header input, .master-header select, .master-header textarea{ 
      background:#eafff3 !important;
      border:1px solid #16a34a !important;
      font-weight:normal !important;
    }
    
    /* Mostrar valores de los campos en PDF */
    .master-header input, .master-header select, .master-header textarea {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      color: #000 !important;
    }
    
    /* Campos de solo lectura para mostrar datos */
    .print-field {
      display: block !important;
      background:#eafff3 !important;
      border:1px solid #16a34a !important;
      color: #000 !important;
      font-weight: normal !important;
    }
    
    /* Ocultar campos editables en PDF */
    .master-header input[type="text"],
    .master-header input[type="number"],
    .master-header textarea:not([readonly]),
    .master-header select {
      display: none !important;
    }
    
    /* Ocultar sección de logos original en PDF */
    .header-logos {
      display: none !important;
    }
    
    /* Mantener colores de secciones finales */
    .final-title{ 
      background:#d1fae5 !important;
      border:1px solid #16a34a !important;
      border-bottom:none !important;
    }
    .final-body{ 
      background:#d1fae5 !important;
      border:1px solid #16a34a !important;
    }
    .final-body textarea{ 
      background:#eafff3 !important;
      color: #000 !important;
    }
    
    /* Mantener colores de semanas */
    .week{ 
      background:#f9fafb !important; 
      border:1px solid #cbd5e1 !important;
      border-radius:12px !important;
    }
    
    /* Mostrar valores en las semanas */
    .week textarea, .week input {
      border: none !important;
      background: transparent !important;
      color: #000 !important;
    }
    
    /* Mantener colores de modalidades */
    .mod-teo td, .mod-teo{ background:#f7c7cf !important }
    .mod-pra td, .mod-pra{ background:#cfe0f7 !important }
    .mod-aut td, .mod-aut{ background:#fff5a8 !important }
    
    /* Mantener colores de reportes */
    .report-head{ background:#a7d7a7 !important }
    .clar-merged{ background:#ff8c00 !important }
    .eval-head{ background:#dbeafe !important }
    .over-cap{ background:#fee2e2 !important; color:#7f1d1d !important }
    
    /* Mantener colores de badges */
    .badge{ background:#eafff3 !important; border:1px solid #94a3b8 !important }
    .badge.warn{ background:#fee2e2 !important; border-color:#ef4444 !important }
    .exam-badge{ background:#fde68a !important; border:1px solid #f59e0b !important }
    
    /* Ocultar elementos no necesarios en PDF */
    .setup-bar, .export-actions, .logo-actions, .del-doc, .add-doc-inline, 
    .btn, .btn-sm, input[type="file"], .final-note,
    input[type="number"], input[type="text"], select:not([readonly]),
    .course-manager { 
      display:none !important 
    }
    
    /* Mostrar solo lectura para textareas editables */
    textarea:not([readonly]) {
      background: transparent !important;
      border: none !important;
      resize: none !important;
      color: #000 !important;
    }
    
    /* Ajustes de layout para impresión */
    .week{ 
      break-inside:avoid; 
      page-break-inside:avoid;
      margin-bottom:15px !important;
    }
    .page-header{ margin-bottom:10px !important }
    .master-header{ margin:10px 0 !important }
    
    th{ background:#f1f5f9 !important }
  }
  
  @page{ 
    size:A4; 
    margin:12mm;
  }
  
  /* Docentes */
  .docentes-list{ display:flex; flex-direction:column; gap:6px; width:100% }
  .docente-row{ display:flex; gap:6px; width:100% }
  .docente-item{ flex:1; padding:6px 8px; border:1px solid var(--brand); border-radius:8px; background:var(--surface-2); font-size:10pt; font-weight:normal }
  .del-doc{ border:1px solid var(--border-2); border-radius:8px; background:#fee2e2; color:#7f1d1d; font-weight:700; padding:0 10px }
  .del-doc:hover{ filter:brightness(.97) }
</style>
</head>
<body>
<div class="container">
  <!-- Logos flotantes para PDF -->
  <div class="pdf-logos">
    <div class="pdf-logo-combined">
      <img class="pdf-logo" id="pdf-logo-univ" alt="USAC CUNOC" />
      <img class="pdf-logo" id="pdf-logo-carrera" alt="Logo Carrera" />
    </div>
  </div>

  <div class="page-header">
    <h1>INSTRUMENTO CLAR · Planificación Semanal</h1>
    <img class="logo-usac" id="usacBaseLogo" alt="USAC CUNOC" />
  </div>

  <!-- Gestión de cursos -->
  <div class="course-manager">
    <h3>Gestión de Cursos</h3>
    <div class="course-actions">
      <select id="course-select" class="course-select">
        <option value="">Seleccionar curso...</option>
      </select>
      <button id="btn-new-course" class="btn success">Nuevo Curso</button>
      <button id="btn-save-course" class="btn">Guardar Curso</button>
      <button id="btn-rename-course" class="btn ghost">Renombrar</button>
      <button id="btn-delete-course" class="btn warn">Eliminar</button>
      <button id="btn-export-course" class="btn">Exportar a Archivo</button>
      <input type="file" id="import-file" accept=".json" style="display:none" />
      <button id="btn-import-course" class="btn ghost">Importar desde Archivo</button>
    </div>
  </div>

  <div class="setup-bar" role="region" aria-label="Configuración de semanas">
    <label for="weeks-count">Semanas:
      <input type="number" id="weeks-count" min="1" max="40" value="16" />
    </label>
    <label for="weeks-start">Inicio (YYYY-MM-DD):
      <input type="date" id="weeks-start" />
    </label>
    <label style="display:flex;align-items:center;gap:6px" for="weeks-snap">
      <input type="checkbox" id="weeks-snap" checked /> Ajustar al lunes (Lun–Vie)
    </label>
    <button id="create-weeks" class="btn success">Crear semanas</button>
    <button id="btn-clear" class="btn ghost" title="Borrar todo y reiniciar">Limpiar</button>
  </div>

  <!-- Encabezado maestro (único) -->
  <section class="master-header" aria-labelledby="hdr-title">
    <h2 id="hdr-title" class="visually-hidden" style="position:absolute;left:-9999px">Encabezado del curso</h2>

    <div class="header-top">
      <div class="top-left">
        <div class="row">
          <label for="fld-universidad">Universidad:</label>
          <textarea id="fld-universidad" data-field="universidad" readonly title="Campo fijo: no editable">Universidad de San Carlos de Guatemala</textarea>
        </div>
        <div class="row">
          <label for="fld-centro">Centro Universitario:</label>
          <textarea id="fld-centro" data-field="centro" readonly title="Campo fijo: no editable">Centro Universitario de Occidente (CUNOC)</textarea>
        </div>
        <div class="row">
          <label for="fld-division">División:</label>
          <textarea id="fld-division" data-field="division" readonly title="Campo fijo: no editable">Ciencias Económicas (CCEE)</textarea>
        </div>
        <div class="row">
          <label for="fld-carrera">Carrera:</label>
          <select id="fld-carrera" data-field="carrera" aria-describedby="help-carrera">
            <option>Administración de Empresas</option>
            <option>Contaduría Pública y Auditoría</option>
            <option>Economía</option>
            <option>Área Común</option>
          </select>
          <span id="help-carrera" class="final-note">Seleccione la carrera</span>
        </div>
        
        <!-- CAMPOS CORREGIDOS: Códigos y CLAR en filas separadas -->
        <div class="row">
          <label for="fld-cod-carrera">Código de la carrera:</label>
          <input id="fld-cod-carrera" type="text" data-field="cod_carrera" value="120004" />
          <div class="print-field" id="print-cod-carrera" style="display:none">120004</div>
        </div>
        
        <div class="row">
          <label for="fld-cod-curso">Código del curso:</label>
          <input id="fld-cod-curso" type="text" data-field="cod_curso" value="482" />
          <div class="print-field" id="print-cod-curso" style="display:none">482</div>
        </div>
        
        <div class="row">
          <label for="fld-clar">Créditos CLAR (Σ horas/24):</label>
          <input id="fld-clar" type="text" data-field="clar_credit" value="0.00" readonly
                 title="Se calcula automáticamente con la sumatoria final" />
          <div class="print-field" id="print-clar" style="display:none">0.00</div>
        </div>
      </div>

      <aside class="header-logos" aria-label="Logotipos">
        <h3>Logotipos</h3>
        <div class="logos-container">
          <div class="logo-combined">
            <div class="logo-item">
              <img id="logo-univ-img" class="logo-preview" alt="Logo USAC CUNOC" />
              <div class="logo-label">USAC CUNOC</div>
            </div>
            <div class="logo-item">
              <img id="logo-carrera-img" class="logo-preview" alt="Logo Carrera" />
              <div class="logo-label">Carrera</div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <div class="header-bottom">
      <div class="row span-2">
        <label for="fld-curso">Nombre del curso:</label>
        <textarea id="fld-curso" data-field="curso">Mercadotecnia II</textarea>
        <div class="print-field" id="print-curso" style="display:none">Mercadotecnia II</div>
      </div>

      <div class="row span-2">
        <label for="fld-requisito">Pre-requisitos (Nombre y código):</label>
        <textarea id="fld-requisito" data-field="requisito">Mercadotecnia I (Código 123)</textarea>
        <div class="print-field" id="print-requisito" style="display:none">Mercadotecnia I (Código 123)</div>
        <label for="fld-postreq" style="min-width:auto">Post-requisitos (Nombre y código):</label>
        <textarea id="fld-postreq" data-field="postrequisito">—</textarea>
        <div class="print-field" id="print-postreq" style="display:none">—</div>
      </div>

      <!-- Ciclo Académico y Año - CORREGIDO -->
      <div class="row span-2">
        <label for="fld-ciclo">Ciclo Académico:</label>
        <select id="fld-ciclo" data-field="ciclo_academico" style="max-width:220px">
          <option>Primer Semestre</option>
          <option>Segundo Semestre</option>
        </select>
        <div class="print-field" id="print-ciclo" style="display:none">Primer Semestre</div>

        <label for="fld-semestre" style="min-width:auto">Semestre:</label>
        <select id="fld-semestre" data-field="semestre" style="max-width:120px">
          <option>Primero</option>
          <option>Segundo</option>
          <option>Tercero</option>
          <option>Cuarto</option>
          <option>Quinto</option>
          <option>Sexto</option>
          <option>Séptimo</option>
          <option>Octavo</option>
          <option>Noveno</option>
          <option>Décimo</option>
        </select>
        <div class="print-field" id="print-semestre" style="display:none">Primero</div>

        <label for="fld-anio" style="min-width:auto">Año:</label>
        <input id="fld-anio" type="number" data-field="anio_academico" min="2000" max="2100"
               style="max-width:120px" value="2025" />
        <div class="print-field" id="print-anio" style="display:none">2025</div>
      </div>

      <div class="row span-2">
        <label>Nombre del profesor:</label>
        <div class="docentes-list" id="docentes-list">
          <div class="docente-row">
            <textarea class="docente-item" placeholder="Nombre del docente"></textarea>
            <div class="print-field docente-print" style="display:none"></div>
            <button type="button" class="del-doc" title="Eliminar docente">×</button>
          </div>
        </div>
        <button type="button" class="add-doc-inline" title="Agregar otro docente">+ Docente</button>
        <textarea id="fld-docente" data-field="docente" style="display:none"></textarea>
      </div>

      <div class="row span-2">
        <label for="fld-titulo">Título universitario del docente:</label>
        <textarea id="fld-titulo" data-field="titulo_docente">PEM en Psicología</textarea>
        <div class="print-field" id="print-titulo" style="display:none">PEM en Psicología</div>
      </div>
      <div class="row span-2">
        <label for="fld-email">Correo institucional:</label>
        <textarea id="fld-email" data-field="email">nombre.apellido@cunoc.edu.gt</textarea>
        <div class="print-field" id="print-email" style="display:none">nombre.apellido@cunoc.edu.gt</div>
      </div>

      <div class="row span-2">
        <label for="fld-acuerdo">Descripción del acuerdo de aprobación de la Carrera:</label>
        <textarea id="fld-acuerdo" data-field="acuerdo_carrera"></textarea>
        <div class="print-field" id="print-acuerdo" style="display:none"></div>
      </div>

      <div class="row span-2">
        <label for="fld-horario">Horario de clases:</label>
        <textarea id="fld-horario" data-field="horario">Lunes: 15:45 a 17:15 horas  |  Martes: 16:30 a 17:15 horas</textarea>
        <div class="print-field" id="print-horario" style="display:none">Lunes: 15:45 a 17:15 horas  |  Martes: 16:30 a 17:15 horas</div>
        <label for="fld-seccion" style="min-width:auto">Sección:</label>
        <input id="fld-seccion" type="text" data-field="seccion" style="max-width:120px" value="B" />
        <div class="print-field" id="print-seccion" style="display:none">B</div>
      </div>

      <div class="row span-2">
        <label for="fld-desc">Descripción del curso:</label>
        <textarea id="fld-desc" data-field="desc_curso"></textarea>
        <div class="print-field" id="print-desc" style="display:none"></div>
      </div>
      <div class="row span-2">
        <label for="fld-obj">Objetivos:</label>
        <textarea id="fld-obj" data-field="objetivos"></textarea>
        <div class="print-field" id="print-obj" style="display:none"></div>
      </div>
    </div>
  </section>

  <div id="weeks-container" aria-live="polite"></div>
  <div id="validation-result" class="total-validation" aria-atomic="true" style="font-weight:700; margin-top:8px"></div>

  <!-- Evaluación (antes del reporte final) -->
  <div id="evaluation-section" class="eval-wrap"></div>

  <!-- Reporte final -->
  <div id="summary-report" class="report-wrap"></div>

  <!-- Secciones finales -->
  <div id="final-sections" class="final-wrap">
    <div class="final-title">Reglamento de Evaluación:</div>
    <div class="final-body">
      <textarea id="eval-reglamento" readonly>Artículo 20. Normativo de Evaluación y Promoción de los estudiantes del Centro Universitarios de Occidente. "Los requisitos para someterse a exámenes finales de recuperación son: estar legalmente inscrito, tener asignado el curso, haber llenado el mínimo de puntos de zona que establece este Normativo, presentar su carné de estudiante, u otro medio de identificación a criterio del examinador, su recibo de haber pagado los derechos de exámenes, y haber cumplido con el 80% de asistencia".</textarea>
    </div>
    <div class="final-title" style="margin-top:12px">Bibliografía/ E-Grafía</div>
    <div class="final-body">
      <textarea id="biblio-egrafia" placeholder="Ingrese la bibliografía / e-grafía…"></textarea>
      <div class="print-field" id="print-biblio" style="display:none"></div>
      <div class="final-note">Consejo: cite con formato APA/IEEE, y agregue DOI/URL cuando aplique.</div>
    </div>
  </div>

  <div class="export-actions">
    <button id="btn-export-excel" class="btn">Exportar a Excel</button>
    <button id="btn-export-word" class="btn" style="background:#6366f1">Exportar a Word</button>
    <button id="btn-export-pdf" class="btn warn">Exportar a PDF</button>
    <button id="btn-export-csv" class="btn ghost">Exportar a CSV</button>
  </div>
</div>

<script>
  // ======= Estado global =======
  let weekCount = 0;
  const COURSES_STORAGE_KEY = 'clar_usac_courses_v2';
  const CURRENT_COURSE_KEY = 'clar_usac_current_course_v2';
  const CLAR_DIVISOR = 24; // fijo
  let warnedProceso = false;
  let warnedExamen = false;
  let courses = {};
  let currentCourseId = null;

  // ======= Gestión de Cursos =======
  function initCourseManager() {
    loadCourses();
    updateCourseSelect();
    
    // Event listeners para gestión de cursos
    document.getElementById('btn-new-course').addEventListener('click', createNewCourse);
    document.getElementById('btn-save-course').addEventListener('click', saveCurrentCourse);
    document.getElementById('btn-rename-course').addEventListener('click', renameCurrentCourse);
    document.getElementById('btn-delete-course').addEventListener('click', deleteCurrentCourse);
    document.getElementById('btn-export-course').addEventListener('click', exportCurrentCourse);
    document.getElementById('btn-import-course').addEventListener('click', () => document.getElementById('import-file').click());
    document.getElementById('import-file').addEventListener('change', importCourseFromFile);
    document.getElementById('course-select').addEventListener('change', switchCourse);
    
    // Cargar curso actual o crear uno por defecto
    const savedCurrentId = localStorage.getItem(CURRENT_COURSE_KEY);
    if (savedCurrentId && courses[savedCurrentId]) {
      loadCourse(savedCurrentId);
    } else if (Object.keys(courses).length > 0) {
      loadCourse(Object.keys(courses)[0]);
    } else {
      createNewCourse();
    }
  }

  function loadCourses() {
    try {
      const saved = localStorage.getItem(COURSES_STORAGE_KEY);
      if (saved) {
        courses = JSON.parse(saved);
      }
    } catch (e) {
      console.warn('Error cargando cursos:', e);
      courses = {};
    }
  }

  function saveCourses() {
    try {
      localStorage.setItem(COURSES_STORAGE_KEY, JSON.stringify(courses));
    } catch (e) {
      console.warn('Error guardando cursos:', e);
      alert('Error al guardar cursos. El almacenamiento puede estar lleno.');
    }
  }

  function updateCourseSelect() {
    const select = document.getElementById('course-select');
    const currentValue = select.value;
    
    select.innerHTML = '<option value="">Seleccionar curso...</option>';
    
    Object.keys(courses).forEach(id => {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = courses[id].name || `Curso ${id}`;
      select.appendChild(option);
    });
    
    if (currentCourseId) {
      select.value = currentCourseId;
    } else if (currentValue) {
      select.value = currentValue;
    }
  }

  function createNewCourse() {
    const courseId = 'course_' + Date.now();
    const courseName = prompt('Nombre del nuevo curso:', 'Nuevo Curso');
    
    if (courseName) {
      courses[courseId] = {
        id: courseId,
        name: courseName,
        data: getDefaultCourseData(),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      saveCourses();
      updateCourseSelect();
      loadCourse(courseId);
    }
  }

  function saveCurrentCourse() {
    if (!currentCourseId) return;
    
    courses[currentCourseId].data = collectCurrentState();
    courses[currentCourseId].updatedAt = new Date().toISOString();
    courses[currentCourseId].name = document.getElementById('fld-curso').value || 'Curso sin nombre';
    
    saveCourses();
    updateCourseSelect();
    
    // Mostrar confirmación
    const btn = document.getElementById('btn-save-course');
    const originalText = btn.textContent;
    btn.textContent = '✓ Guardado';
    btn.style.background = '#10b981';
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = '';
    }, 2000);
  }

  function renameCurrentCourse() {
    if (!currentCourseId) return;
    
    const newName = prompt('Nuevo nombre del curso:', courses[currentCourseId].name);
    if (newName) {
      courses[currentCourseId].name = newName;
      saveCourses();
      updateCourseSelect();
    }
  }

  function deleteCurrentCourse() {
    if (!currentCourseId) return;
    
    if (confirm(`¿Está seguro de eliminar el curso "${courses[currentCourseId].name}"?`)) {
      delete courses[currentCourseId];
      saveCourses();
      updateCourseSelect();
      
      // Cargar otro curso o crear uno nuevo
      const remainingIds = Object.keys(courses);
      if (remainingIds.length > 0) {
        loadCourse(remainingIds[0]);
      } else {
        createNewCourse();
      }
    }
  }

  function switchCourse() {
    const selectedId = document.getElementById('course-select').value;
    if (selectedId && courses[selectedId]) {
      // Guardar curso actual antes de cambiar
      if (currentCourseId) {
        saveCurrentCourse();
      }
      loadCourse(selectedId);
    }
  }

  function loadCourse(courseId) {
    if (!courses[courseId]) return;
    
    currentCourseId = courseId;
    localStorage.setItem(CURRENT_COURSE_KEY, courseId);
    
    const course = courses[courseId];
    applyState(course.data);
    
    // Actualizar interfaz
    document.getElementById('course-select').value = courseId;
    document.title = `INSTRUMENTO CLAR – ${course.name}`;
    
    console.log(`Curso cargado: ${course.name}`);
  }

  function exportCurrentCourse() {
    if (!currentCourseId) return;
    
    const course = courses[currentCourseId];
    const exportData = {
      version: '2.0',
      exportedAt: new Date().toISOString(),
      course: course
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `curso_clar_${course.name.replace(/[^a-z0-9]/gi, '_')}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  function importCourseFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importData = JSON.parse(e.target.result);
        
        if (importData.version && importData.course) {
          const course = importData.course;
          const courseId = 'imported_' + Date.now();
          
          courses[courseId] = {
            ...course,
            id: courseId,
            importedAt: new Date().toISOString()
          };
          
          saveCourses();
          updateCourseSelect();
          loadCourse(courseId);
          
          alert(`Curso "${course.name}" importado exitosamente.`);
        } else {
          alert('El archivo no es un curso válido.');
        }
      } catch (error) {
        alert('Error al importar el curso: ' + error.message);
      }
    };
    
    reader.readAsText(file);
    event.target.value = ''; // Reset input
  }

  function getDefaultCourseData() {
    return {
      controls: { weeks: 16, start: '', snap: true },
      logos: { univ: '', carrera: '' },
      weeks: [],
      docente: '',
      reglamento: '',
      biblio: ''
    };
  }

  // ======= Utilidades =======
  function autoResize(el){ if(!el) return; el.style.height='auto'; el.style.height = (el.scrollHeight) + 'px'; }
  function initAutosize(scope){ (scope||document).querySelectorAll('textarea').forEach(t=>{ autoResize(t); t.addEventListener('input', ()=>autoResize(t)); }); }
  function parseLocalDate(str){ if (typeof str !== 'string') return new Date(str); const parts = str.split('-'); if (parts.length!==3) return new Date(str); const y=+parts[0], mo=+parts[1]-1, d=+parts[2]; return new Date(y, mo, d); }
  function addDays(date, days){ const d=new Date(date.getTime()); d.setDate(d.getDate()+days); return d; }
  function toMonday(date){ const d=new Date(date.getTime()); const day=d.getDay(); const diff=(day===0?-6:1-day); d.setDate(d.getDate()+diff); return d; }
  function formatDMY(date){ const dd=String(date.getDate()).padStart(2,'0'); const mm=String(date.getMonth()+1).padStart(2,'0'); const yyyy=date.getFullYear(); return `${dd}/${mm}/${yyyy}`; }
  function endOfWorkWeek(monday){ return addDays(monday, 4); }
  function parseNum(val){ if(val==null||val==='') return 0; return parseFloat(String(val).replace(',', '.'))||0; }

  // ======= Sincronización de campos para PDF =======
  function syncPrintFields() {
    // Sincronizar todos los campos con sus versiones de impresión
    const fields = [
      { input: 'fld-cod-carrera', print: 'print-cod-carrera' },
      { input: 'fld-cod-curso', print: 'print-cod-curso' },
      { input: 'fld-clar', print: 'print-clar' },
      { input: 'fld-curso', print: 'print-curso' },
      { input: 'fld-requisito', print: 'print-requisito' },
      { input: 'fld-postreq', print: 'print-postreq' },
      { input: 'fld-ciclo', print: 'print-ciclo' },
      { input: 'fld-semestre', print: 'print-semestre' },
      { input: 'fld-anio', print: 'print-anio' },
      { input: 'fld-titulo', print: 'print-titulo' },
      { input: 'fld-email', print: 'print-email' },
      { input: 'fld-acuerdo', print: 'print-acuerdo' },
      { input: 'fld-horario', print: 'print-horario' },
      { input: 'fld-seccion', print: 'print-seccion' },
      { input: 'fld-desc', print: 'print-desc' },
      { input: 'fld-obj', print: 'print-obj' },
      { input: 'biblio-egrafia', print: 'print-biblio' }
    ];

    fields.forEach(field => {
      const inputEl = document.getElementById(field.input);
      const printEl = document.getElementById(field.print);
      if (inputEl && printEl) {
        if (inputEl.tagName === 'SELECT') {
          printEl.textContent = inputEl.options[inputEl.selectedIndex].text;
        } else {
          printEl.textContent = inputEl.value;
        }
      }
    });

    // Sincronizar docentes
    const docenteItems = document.querySelectorAll('.docente-item');
    const docentePrints = document.querySelectorAll('.docente-print');
    docenteItems.forEach((item, index) => {
      if (docentePrints[index]) {
        docentePrints[index].textContent = item.value;
      }
    });

    // Sincronizar logos para PDF
    const logoUniv = document.getElementById('logo-univ-img');
    const logoCarrera = document.getElementById('logo-carrera-img');
    const pdfLogoUniv = document.getElementById('pdf-logo-univ');
    const pdfLogoCarrera = document.getElementById('pdf-logo-carrera');

    if (logoUniv && pdfLogoUniv) {
      pdfLogoUniv.src = logoUniv.src;
    }
    if (logoCarrera && pdfLogoCarrera) {
      pdfLogoCarrera.src = logoCarrera.src;
    }
  }

  // ======= Inicialización de logos =======
  function initLogos(){
    // Logo del CUNOC - URL actualizada
    const logoUniv = document.getElementById('logo-univ-img');
    const logoCarrera = document.getElementById('logo-carrera-img');
    const pdfLogoUniv = document.getElementById('pdf-logo-univ');
    const pdfLogoCarrera = document.getElementById('pdf-logo-carrera');
    
    // Logo CUNOC funcional
    if(logoUniv) {
      logoUniv.src = 'https://ddo.usac.edu.gt/wp-content/uploads/2024/03/Logo-CUNOC.jpg';
      logoUniv.alt = 'USAC CUNOC';
      logoUniv.onerror = function() {
        // Fallback si la imagen no carga
        this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiByeD0iOCIgZmlsbD0iI0VBRkFFMyIvPgo8dGV4dCB4PSI0MCIgeT0iNDUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMxNkExN0EiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCI+VVNBQzwvdGV4dD4KPHRleHQgeD0iNDAiIHk9IjU4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjMTZBMTdBIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iOCI+Q1VOT0M8L3RleHQ+Cjwvc3ZnPg==';
      };
    }
    
    // Logo de carrera
    if(logoCarrera) {
      logoCarrera.src = 'https://th.bing.com/th/id/OIP.1jxBFAS5oRV3u1SV7rTBNAHaHa?rs=1&pid=ImgDetMain';
      logoCarrera.alt = 'Logo Carrera';
      logoCarrera.onerror = function() {
        // Fallback si la imagen no carga
        this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiByeD0iOCIgZmlsbD0iI0VBRkFFMyIvPgo8dGV4dCB4PSI0MCIgeT0iNDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMxNkExN0EiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCI+Q2FycmVyYTwvdGV4dD4KPC9zdmc+';
      };
    }

    // Sincronizar logos PDF
    if (pdfLogoUniv && logoUniv) {
      pdfLogoUniv.src = logoUniv.src;
    }
    if (pdfLogoCarrera && logoCarrera) {
      pdfLogoCarrera.src = logoCarrera.src;
    }
  }

  // ======= Docentes (add / remove) =======
  function enableDocentes(){
    const list = document.getElementById('docentes-list');
    const hidden = document.getElementById('fld-docente');
    function syncDocentesToHidden(){
      const vals = Array.from(list.querySelectorAll('.docente-item'))
        .map(t=>t.value.trim())
        .filter(Boolean);
      if(hidden){ hidden.value = vals.join('\\n'); }
      syncPrintFields(); // Sincronizar también para PDF
    }
    list.addEventListener('input', syncDocentesToHidden);
    document.addEventListener('click', (evt)=>{
      const addBtn = evt.target.closest('.add-doc-inline');
      if(addBtn){
        evt.preventDefault();
        const row=document.createElement('div');
        row.className='docente-row';
        row.innerHTML='<textarea class="docente-item" placeholder="Nombre del docente"></textarea><div class="print-field docente-print" style="display:none"></div><button type="button" class="del-doc" title="Eliminar docente">×</button>';
        list.appendChild(row);
        const ta=row.querySelector('textarea'); autoResize(ta); ta.focus();
        syncDocentesToHidden();
        return;
      }
      const delBtn = evt.target.closest('.del-doc');
      if(delBtn && list.contains(delBtn)){
        const row = delBtn.closest('.docente-row');
        if(row){
          if(list.querySelectorAll('.docente-row').length > 1){ row.remove(); }
          else{ row.querySelector('.docente-item').value=''; }
          syncDocentesToHidden();
        }
      }
    });
  }

  // ======= Filas de sesiones =======
  function createSessionRow(idx, session, modality, modClass){
    return `
      <tr class="${modClass}">
        <td>${session}</td>
        <td>${modality}</td>
        <td class="description-cell"><textarea aria-label="Descripción ${session} ${idx}" oninput="autoResize(this)"></textarea></td>
        <td><input type="number" min="0" step="any" class="short-input minutos" aria-label="Minutos ${session} ${idx}" /></td>
        <td><input type="number" min="0" step="any" class="short-input puntos-netos" aria-label="Puntos netos ${session} ${idx}" /></td>
        <td><input type="number" class="short-input puntos-acumulados" readonly aria-label="Puntos acumulados ${session} ${idx}" /></td>
      </tr>`;
  }

  // ======= Crear semana =======
  function addWeek(startDateOverride){
    weekCount++;
    const container=document.getElementById('weeks-container');
    const weekDiv=document.createElement('section');
    weekDiv.className='week';
    weekDiv.setAttribute('aria-labelledby', `wk-${weekCount}-title`);

    let labelFecha=''; let rangeHTML='';
    if(startDateOverride instanceof Date){
      const d=new Date(startDateOverride.getTime());
      const monday=toMonday(d); const friday=endOfWorkWeek(monday);
      labelFecha = ` — Inicio: ${formatDMY(d)}`;
      rangeHTML = `<div class="week-range">Semana del ${formatDMY(monday)} al ${formatDMY(friday)} (Lun–Vie)</div>`;
    }

    weekDiv.innerHTML = `
      <h2 id="wk-${weekCount}-title">Semana ${weekCount}${labelFecha}</h2>
      ${rangeHTML}
      <table aria-label="Tabla de sesiones semana ${weekCount}">
        <thead>
          <tr>
            <th>Sesión</th>
            <th>Modalidad</th>
            <th>Descripción</th>
            <th>Minutos</th>
            <th>Puntos netos</th>
            <th>Puntos acumulados</th>
          </tr>
        </thead>
        <tbody>
          ${['1','2','3'].map((s, i)=>`
            ${createSessionRow(i+1, 'Sesión '+s, 'Presencial teórico/ virtual/sincrónico', 'mod-teo')}
            ${createSessionRow(i+1, 'Sesión '+s, 'Presencial práctico/virtual/sincrónico. Interacción de profesor y estudiante', 'mod-pra')}
            ${createSessionRow(i+1, 'Sesión '+s, 'No presencial (autónomo)', 'mod-aut')}
          `).join('')}
        </tbody>
      </table>
      <div class="week-summary" aria-live="polite">
        <span class="badge" data-week-min>Total minutos: <strong class="val">0</strong></span>
        <span class="badge" data-week-hrs>Horas: <strong class="val">0.00</strong></span>
        <span class="badge" data-week-pts>Total puntos: <strong class="val">0.00</strong> <span class="note-muted">(objetivo recomendado ≤ 100)</span></span>
      </div>`;

    container.appendChild(weekDiv);
    initAutosize(weekDiv);

    weekDiv.querySelectorAll('.puntos-netos, .minutos').forEach(inp=>{
      inp.addEventListener('input', ()=>{ computeAll(); });
      inp.addEventListener('change', ()=>{ computeAll(); });
    });

    computeAll();
  }

  // ======= Etiquetar última semana como examen =======
  function tagExamWeek(){
    document.querySelectorAll('.week .exam-badge').forEach(e=>e.remove());
    const weeks = document.querySelectorAll('#weeks-container .week');
    if(weeks.length===0) return;
    const last = weeks[weeks.length-1];
    const badge = document.createElement('div');
    badge.className='exam-badge';
    badge.textContent='Examen final (máx. 30 pts)';
    last.appendChild(badge);
  }

  // ======= Cálculos y EVALUACIÓN =======
  function computeAll(){
    let totalMinutes = 0;
    document.querySelectorAll('#weeks-container .minutos').forEach(i=>{ const v=parseNum(i.value); if(v>=0) totalMinutes += v; });

    // Puntos acumulados por semana + totales por semana
    document.querySelectorAll('#weeks-container .week').forEach(week=>{
      let runningPts = 0; const rows = week.querySelectorAll('.puntos-netos');
      const acc = week.querySelectorAll('.puntos-acumulados');
      let weekMin = 0; let weekPts = 0;
      rows.forEach((inp, idx)=>{ const pts=(parseNum(inp.value)||0); runningPts += pts; if(acc[idx]) acc[idx].value = runningPts.toFixed(2); weekPts += pts; });
      week.querySelectorAll('.minutos').forEach(inp=>{ const m=(parseNum(inp.value)||0); weekMin += m; });
      const weekHrs = weekMin/60;
      const badgeMin = week.querySelector('[data-week-min] .val'); if(badgeMin) badgeMin.textContent = String(Math.round(weekMin));
      const badgeHrs = week.querySelector('[data-week-hrs] .val'); if(badgeHrs) badgeHrs.textContent = weekHrs.toFixed(2);
      const badgePts = week.querySelector('[data-week-pts]'); if(badgePts){ const val=badgePts.querySelector('.val'); if(val) val.textContent = weekPts.toFixed(2); badgePts.classList.toggle('warn', weekPts>100); }
    });

    const totalHours = totalMinutes / 60; const clarTotal = totalHours / CLAR_DIVISOR;
    const result = document.getElementById('validation-result');
    if(result){ result.textContent = `CLAR total (Σ horas / ${CLAR_DIVISOR}): ${clarTotal.toFixed(2)}  ·  Horas: ${totalHours.toFixed(2)}  ·  Minutos: ${totalMinutes.toFixed(0)}`; }

    tagExamWeek();
    computeEvaluationSection();
    computeSummaryReport();
  }

  function computeEvaluationSection(){
    const weeks = Array.from(document.querySelectorAll('#weeks-container .week'));
    let procesoNet = 0;
    let examenNet = 0;
    weeks.forEach((week, i)=>{
      let sum = 0;
      week.querySelectorAll('.puntos-netos').forEach(inp=>{ sum += parseNum(inp.value)||0; });
      if(i === weeks.length-1){ examenNet = sum; } else { procesoNet += sum; }
    });

    const procesoRaw = procesoNet;
    const examenRaw = examenNet;
    const procesoPts = Math.min(70, procesoRaw);
    const examenPts  = Math.min(30, examenRaw);
    const total = procesoPts + examenPts;

    // Alertas al cruzar el límite
    if(procesoRaw > 70 && !warnedProceso){ warnedProceso = true; alert('⚠️ La PONDERACIÓN DEL PROCESO DE APRENDIZAJE supera los 70 puntos (semanas 1 a N-1).'); }
    if(procesoRaw <= 70 && warnedProceso){ warnedProceso = false; }
    if(examenRaw > 30 && !warnedExamen){ warnedExamen = true; alert('⚠️ El EXAMEN FINAL supera los 30 puntos (última semana).'); }
    if(examenRaw <= 30 && warnedExamen){ warnedExamen = false; }

    const html = `
      <div class="eval-title">EVALUACIÓN</div>
      <table class="eval-table">
        <thead>
          <tr class="eval-head">
            <th>Concepto</th>
            <th>Puntos</th>
          </tr>
        </thead>
        <tbody>
          <tr class="${procesoRaw>70?'over-cap':''}">
            <td>Ponderación del proceso de aprendizaje (semanas 1 a N-1, máx. 70)</td>
            <td>${procesoPts.toFixed(2)}${procesoRaw>70?'*':''}</td>
          </tr>
          <tr class="${examenRaw>30?'over-cap':''}">
            <td>Examen final (suma de la última semana, máx. 30)</td>
            <td>${examenPts.toFixed(2)}${examenRaw>30?'*':''}</td>
          </tr>
          <tr class="eval-total">
            <td>Total acumulado</td>
            <td>${total.toFixed(2)}</td>
          </tr>
        </tbody>
      </table>
      ${(procesoRaw>70||examenRaw>30)?'<div class="final-note">* El valor mostrado fue recortado al máximo permitido.</div>':''}`;

    const mount=document.getElementById('evaluation-section');
    if(mount) mount.innerHTML = html;
  }

  // ======= Reporte final =======
  function computeSummaryReport(){
    const sumBy = { teo:0, pra:0, aut:0 };
    document.querySelectorAll('#weeks-container .minutos').forEach(inp=>{
      const val=parseNum(inp.value); const v=Number.isFinite(val)?val:0; const tr=inp.closest('tr'); if(!tr) return;
      if(tr.classList.contains('mod-teo')) sumBy.teo += v;
      else if(tr.classList.contains('mod-pra')) sumBy.pra += v;
      else if(tr.classList.contains('mod-aut')) sumBy.aut += v;
    });
    const hours = { teo:sumBy.teo/60, pra:sumBy.pra/60, aut:sumBy.aut/60 };
    const totals = {
      min: sumBy.teo + sumBy.pra + sumBy.aut,
      hrs: (sumBy.teo + sumBy.pra + sumBy.aut)/60,
      clar: ((sumBy.teo + sumBy.pra + sumBy.aut)/60) / CLAR_DIVISOR,
    };
    const fmt = (n,d=2)=> Number.isFinite(n) ? n.toFixed(d) : '0.00';

    const clarField = document.querySelector('.master-header [data-field="clar_credit"]');
    if(clarField) clarField.value = totals.clar.toFixed(2);

    const html = `
      <div class="report-title">REPORTE FINAL</div>
      <table class="report-table">
        <thead>
          <tr class="report-head">
            <th>TIPO DE TRABAJO</th>
            <th>Minutos por Semestre</th>
            <th>Horas por Semestre (min/60)</th>
            <th>CLAR</th>
          </tr>
        </thead>
        <tbody>
          <tr class="row-teo">
            <td>Presencial teórico/ virtual/sincrónico</td>
            <td>${fmt(sumBy.teo,0)}</td>
            <td>${fmt(hours.teo,2)}</td>
            <td class="clar-merged" rowspan="4">${totals.clar.toFixed(2)}</td>
          </tr>
          <tr class="row-pra">
            <td>Presencial práctico/virtual/sincrónico. Interacción de profesor y estudiante</td>
            <td>${fmt(sumBy.pra,0)}</td>
            <td>${fmt(hours.pra,2)}</td>
          </tr>
          <tr class="row-aut">
            <td><strong>Autónomo</strong></td>
            <td>${fmt(sumBy.aut,0)}</td>
            <td>${fmt(hours.aut,2)}</td>
          </tr>
          <tr class="row-total">
            <td><strong>Total</strong></td>
            <td><strong>${fmt(totals.min,0)}</strong></td>
            <td><strong>${fmt(totals.hrs,2)}</strong></td>
          </tr>
        </tbody>
      </table>`;
    const mount=document.getElementById('summary-report');
    if(mount) mount.innerHTML = html;
  }

  // ======= Controladores - CORREGIDO =======
  function generateWeeksFromControls(){
    try{
      const countEl=document.getElementById('weeks-count');
      const startEl=document.getElementById('weeks-start');
      const snapEl=document.getElementById('weeks-snap');
      const n=parseInt(countEl.value,10);
      if(!Number.isInteger(n)||n<=0){ alert('Ingrese un número válido de semanas.'); return; }
      const baseRaw = startEl.value ? parseLocalDate(startEl.value) : new Date();
      if(isNaN(baseRaw.getTime())){ alert('Fecha inválida. Use el selector de fecha.'); return; }
      const base = snapEl && snapEl.checked ? toMonday(baseRaw) : baseRaw;
      const container=document.getElementById('weeks-container'); container.innerHTML=''; weekCount=0;
      for(let i=0;i<n;i++) addWeek(addDays(base, 7*i));
      enableDocentes(); initAutosize(document);
      computeAll();
    }catch(e){ console.error(e); alert('No se pudieron crear las semanas desde la barra.'); }
  }

  // ======= Persistencia =======
  function collectCurrentState(){
    const state={
      controls:{ weeks: parseInt(document.getElementById('weeks-count').value||'0',10), start: document.getElementById('weeks-start').value||'', snap: !!document.getElementById('weeks-snap').checked },
      logos:{ univ: document.getElementById('logo-univ-img')?.getAttribute('src')||'', carrera: document.getElementById('logo-carrera-img')?.getAttribute('src')||'' },
      weeks:[],
      docente: document.getElementById('fld-docente')?.value||'',
      reglamento: document.getElementById('eval-reglamento')?.value||'',
      biblio: document.getElementById('biblio-egrafia')?.value||''
    };
    document.querySelectorAll('#weeks-container .week').forEach(week=>{
      const rows = Array.from(week.querySelectorAll('tbody tr')).map(tr=>({ desc: tr.querySelector('textarea')?.value||'', min: tr.querySelector('input.minutos')?.value||'', pts: tr.querySelector('input.puntos-netos')?.value||'' }));
      state.weeks.push({ rows });
    });
    return state;
  }

  function applyState(state){
    if(!state) return;
    try{
      document.getElementById('weeks-count').value = state.controls.weeks || 16;
      document.getElementById('weeks-start').value = state.controls.start || '';
      document.getElementById('weeks-snap').checked = !!state.controls.snap;
      generateWeeksFromControls();
    }catch(e){ console.warn('No se pudo regenerar estructura:', e); }
    if(state.docente){ const list = document.getElementById('docentes-list'); list.innerHTML=''; state.docente.split(/\\n+/).forEach(n=>{ const row=document.createElement('div'); row.className='docente-row'; row.innerHTML='<textarea class="docente-item" placeholder="Nombre del docente"></textarea><div class="print-field docente-print" style="display:none"></div><button type="button" class="del-doc" title="Eliminar docente">×</button>'; row.querySelector('textarea').value=n; list.appendChild(row); }); }
    const weeks=document.querySelectorAll('#weeks-container .week');
    weeks.forEach((weekEl, wi)=>{
      const w=state.weeks[wi]; if(!w) return;
      const trs=weekEl.querySelectorAll('tbody tr');
      w.rows?.forEach((row, ri)=>{
        const tr=trs[ri]; if(!tr) return;
        const ta=tr.querySelector('textarea'); if(ta){ ta.value=row.desc||''; autoResize(ta); }
        const min=tr.querySelector('input.minutos'); if(min){ min.value=row.min||''; }
        const pts=tr.querySelector('input.puntos-netos'); if(pts){ pts.value=row.pts||''; }
      });
    });
    document.getElementById('eval-reglamento').value = state.reglamento||'';
    document.getElementById('biblio-egrafia').value = state.biblio||'';
    computeAll();
    syncPrintFields(); // Sincronizar campos para PDF
  }

  // ======= Exportación =======
  function prepareForPrint() {
    syncPrintFields(); // Asegurar que todos los campos estén sincronizados
  }

  function exportPDF(){ 
    prepareForPrint();
    window.print(); 
  }
  
  function downloadBlob(filename, mime, content){ 
    const blob=new Blob([content], {type:mime}); 
    const url=URL.createObjectURL(blob); 
    const a=document.createElement('a'); 
    a.href=url; 
    a.download=filename; 
    a.click(); 
    URL.revokeObjectURL(url); 
  }
  
  function exportExcel(){ 
    downloadBlob('instrumento_clar.xls', 'application/vnd.ms-excel', buildExportHTML()); 
  }
  
  function exportWord(){ 
    prepareForPrint();
    const content = `
<html xmlns:o='urn:schemas-microsoft-com:office:office' 
      xmlns:w='urn:schemas-microsoft-com:office:word' 
      xmlns='http://www.w3.org/TR/REC-html40'>
<head>
<meta charset="utf-8">
<title>INSTRUMENTO CLAR</title>
<!--[if gte mso 9]>
<xml>
<w:WordDocument>
<w:View>Print</w:View>
<w:Zoom>100</w:Zoom>
<w:DoNotOptimizeForBrowser/>
</w:WordDocument>
</xml>
<![endif]-->
<style>
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #000; padding: 4px; }
  .mod-teo td, .mod-teo { background: #f7c7cf; }
  .mod-pra td, .mod-pra { background: #cfe0f7; }
  .mod-aut td, .mod-aut { background: #fff5a8; }
  .report-head { background: #a7d7a7; font-weight: bold; }
  .clar-merged { background: #ff8c00; font-weight: bold; font-size: 18pt; text-align: center; }
  .eval-head { background: #dbeafe; font-weight: bold; }
  .over-cap { background: #fee2e2; color: #7f1d1d; font-weight: 800; }
  .week { page-break-after: always; }
  .print-field { display: block !important; }
</style>
</head>
<body>
${document.querySelector('.page-header')?.outerHTML || ''}
${document.querySelector('.master-header')?.outerHTML || ''}
${document.getElementById('weeks-container')?.innerHTML || ''}
${document.getElementById('evaluation-section')?.innerHTML || ''}
${document.getElementById('summary-report')?.innerHTML || ''}
${document.getElementById('final-sections')?.outerHTML || ''}
</body>
</html>`;
    
    downloadBlob('instrumento_clar.doc', 'application/msword', content);
  }
  
  function exportCSV(){
    const rows = [];
    const header = ['Semana','Fila','Sesión','Modalidad','Descripción','Minutos','Puntos netos','Puntos acumulados'];
    rows.push(header.join(','));
    let weekIdx=0;
    document.querySelectorAll('#weeks-container .week').forEach(week=>{
      weekIdx++;
      let running=0; let rowIdx=0;
      week.querySelectorAll('tbody tr').forEach(tr=>{
        rowIdx++;
        const sesion = tr.children[0]?.textContent?.trim()||'';
        const modalidad = tr.children[1]?.textContent?.trim()||'';
        const desc = tr.querySelector('textarea')?.value?.replace(/\\n/g,' ')||'';
        const minutos = tr.querySelector('input.minutos')?.value||'';
        const pts = parseNum(tr.querySelector('input.puntos-netos')?.value||'')||0; running+=pts;
        const acc = running.toFixed(2);
        const line=[weekIdx,rowIdx,`"${sesion}"`,`"${modalidad}"`,`"${desc}"`,minutos,pts,acc];
        rows.push(line.join(','));
      });
    });
    const csv = rows.join('\\n');
    downloadBlob('instrumento_clar.csv','text/csv;charset=utf-8',csv);
  }

  // ======= Eventos =======
  document.addEventListener('DOMContentLoaded', function(){
    // Inicializar gestión de cursos
    initCourseManager();
    
    // Inicializar logos
    initLogos();
    
    // Inicializar fecha por defecto
    const today = new Date();
    const monday = toMonday(today);
    document.getElementById('weeks-start').valueAsDate = monday;
    
    // Sincronizar campos cuando cambien
    document.querySelectorAll('.master-header input, .master-header select, .master-header textarea').forEach(el => {
      el.addEventListener('input', function() {
        syncPrintFields();
      });
      el.addEventListener('change', function() {
        syncPrintFields();
      });
    });

    // Event listeners
    document.getElementById('create-weeks').addEventListener('click', generateWeeksFromControls);
    document.getElementById('btn-export-excel').addEventListener('click', exportExcel);
    document.getElementById('btn-export-word').addEventListener('click', exportWord);
    document.getElementById('btn-export-pdf').addEventListener('click', exportPDF);
    document.getElementById('btn-export-csv').addEventListener('click', exportCSV);
    document.getElementById('btn-clear').addEventListener('click', ()=>{ if(confirm('Esto borrará el contenido del curso actual. ¿Continuar?')){ clearCurrentCourse(); } });

    // Auto-guardado cuando se modifiquen datos
    document.addEventListener('input', () => {
      if (currentCourseId) {
        // Guardar automáticamente después de un delay
        clearTimeout(window.autoSaveTimeout);
        window.autoSaveTimeout = setTimeout(() => {
          saveCurrentCourse();
        }, 2000);
      }
    });

    enableDocentes(); 
    computeAll(); 
    initAutosize(document);
    syncPrintFields(); // Sincronizar campos inicialmente
  });

  function clearCurrentCourse() {
    if (!currentCourseId) return;
    
    if (confirm('¿Está seguro de limpiar todo el contenido del curso actual?')) {
      // Restablecer a valores por defecto pero mantener el curso
      const defaultData = getDefaultCourseData();
      courses[currentCourseId].data = defaultData;
      applyState(defaultData);
      saveCourses();
    }
  }

  function buildExportHTML() {
    // Función para generar HTML de exportación (simplificada)
    return document.documentElement.outerHTML;
  }
</script>
</body>
</html>
